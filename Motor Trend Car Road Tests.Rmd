---
title: "Motor Trend Car Road Tests. Regression Models Course Project"
author: "Michael Berger"
date: "21 January 2018"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(car)
library(plyr)
library(ggplot2)
library(corrplot)
```
## Abstract

The purpose of this study is to evaluate whether gear type of an automobile is a significant predictor for a  vehicle efficiency expressed in miles per gallon. Moreover it is important to check whether other parameters appear to be significant predictors. 
We will perform the study on a standard mtcars dataset included in R:
The data was extracted from the 1974 Motor Trend US magazine, and comprises fuel consumption and 10 aspects of automobile design and performance for 32 automobiles (1973â€“74 models). R help 

## Exploratory analysis
For the sake of visual simplicity We will rearrange the dataset such that each variable will be ordered according with total amount of correlation with other variables. IN this way a more visually clear correlation plot can be built: 
```{r cars}
data("mtcars")
head(mtcars)
co <-abs(cor(mtcars))
barplot(colSums(co))
mc <- mtcars[,order(colSums(co),decreasing = TRUE)]
#barplot(colSums(abs(cor(mc)))) # just check that the parameters really got sorted by total amount of correlation
co <-abs(cor(mc))
corrplot.mixed(co, upper = "circle")
```

From this plot one can obtain a general understanding of which variables correlate with the most other variables.


##Simple linear modeling
Since the outcome, mpg, is an interval variable, it is reasonable to use simple linear model for the whole study.
The first obvious step is to create a simple model with one predictor, am   

```{r mpg as predicted by manual/automatic, echo=FALSE}
data(mtcars)
mtcars <- mutate(mtcars, cyl = factor(cyl), vs = factor(vs), am = factor(am), gear = factor(gear), carb = factor(carb))
mdlam <- lm(mpg ~ am , data = mtcars)
summary(mdlam)
g1 <- ggplot(data = mtcars) + geom_violin(aes(x = am, y = mpg, fill = am))
#
g1 <- g1 + geom_abline(aes(intercept = mdlam$coef[1] -  mdlam$coef[2] ,slope = mdlam$coef[2]), col = "red")
g1
mdlam$coef
# mtcars$am <- factor(mtcars$am)
# g <- ggplot(data = mtcars, aes(x = am, y = mpg, fill = am))
# g <- g 
# g

```

The line looks fine and the p-values are highly significant.
however, Adjusted R-squared points out that this model accounts for only 34% of variance in the data. Hence, we should expand the model to include more variables. Howevwe, not all variables are necessary in the model, and we know that excess variables cause variance inflation and overfiting.  We will use stepwise model selection procedure to sort out variables which do not contribute to the interpretability.

```{r mpg as predicted by all and step, echo=FALSE}

mtcars <- mutate(mtcars, cyl = factor(cyl), vs = factor(vs), am = factor(am), gear = factor(gear), carb = factor(carb))
mdlall <- lm(mpg ~ . , data = mtcars)
summary(mdlall)
mdlstep <- step(mdlall, direction = "backward", trace=TRUE)
summary(mdlstep)
vif(mdlstep)

# which(vi==max(vi))
# rownames(vi)
# as.list(vi)
# plot(vi)
```

Stepwise Algorithm yeilds a model with 4 variables: cyl, hp, wt, am. Adjusted R-squared of 84% is significantly larger than that of the simplest model with am as only predictor. This points out that 84 of variability in the dat can be explained by the improved model.
Variance inflation factor analysis does not reveal abnormally large (more than 10) values, which implies that model does not contain variables with high corelation with each other.  

p-values for coefficents are significant except for the cyl8 and am1. The first one implies that there is no significant difference between 6 and 8 cylinder engine cars. The second one says there is no difference between gear types. 

```{r Anova, echo=FALSE}

anova(mdlam, mdlstep, mdlall)

```


Anova points out that the  mdlstep's variables are a significant (p-value less than 0.001) improvement over the simplest model, while full model does not give significant improvement over the mdlstep

```{r residuals plot, echo=FALSE}

par(mfrow=c(2,2))
plot(mdlstep)

```

Residuals plots look rather normally distributed which implies that what little variance is left in the model is normally random and unpredictable. 
Standardised residuals are situated close to the normal line  on Q-Q plot, another indication that model leftover variance is random normal.
Cook'd distance plot does not reveal any extreme data that may influence the model in a game-changing way. 


## Conclusion
In this study we have proposed a model which tackles an amount of influence which different cars parameters exert on fuel consumption. A stepwise selection algorythm gave us a model with 4 main influencing parameters: number of cylinders (cyl), horsepower (hp), weight (wt) and gearbox type (am). While all the parameters are significant, the gearbox type is not. Hence we can conclude that the answer to the stydy's question - whether am is a significant predictor for the mpg - is negative. 






===========================================================================